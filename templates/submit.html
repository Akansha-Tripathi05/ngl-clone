<!-- <!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Leave an anonymous message</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>
  <body class="bg-gradient">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-lg">
            <div class="card-body p-4">
              <h3 class="card-title mb-3">Send an anonymous message</h3>
              <p class="text-muted small">Your message will be sent; username is auto-detected when possible.</p>

              <form id="msgForm">
                <input type="hidden" id="username" name="username" />
                <div class="mb-3">
                  <textarea class="form-control form-control-lg" id="message" name="message" rows="4" placeholder="Type your message..." required></textarea>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                  <div id="detected" class="text-muted small">Detecting usernameâ€¦</div>
                  <button type="submit" class="btn btn-primary btn-lg">Send</button>
                </div>
              </form>

              <div id="result" class="mt-3"></div>
            </div>
          </div>

          <p class="text-center text-muted small mt-3">Tip: If you want your Instagram username attached, you can open this page from the profile link or share the page with `?u=theirusername`.</p>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/detect_username.js') }}"></script>
    <script>
      const form = document.getElementById('msgForm');
      const result = document.getElementById('result');
      const detectedEl = document.getElementById('detected');
      const usernameInput = document.getElementById('username');

      // run detection logic from external JS 
      const detected = detectUsername(); // returns string or null
      if(detected) {
        usernameInput.value = detected;
        detectedEl.innerText = `Detected username: ${detected}`;
      } else {
        detectedEl.innerText = 'No username detected (optional)';
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        // if username not detected, still send blank
        const res = await fetch('/submit', {
          method: 'POST',
          body: formData
        });
        const json = await res.json();
        if(json.status === 'ok') {
          result.innerHTML = `<div class="alert alert-success">Message sent. Thank you!</div>`;
          form.reset();
        } else {
          result.innerHTML = `<div class="alert alert-danger">${json.message || 'Error'}</div>`;
        }
      });
    </script>
  </body>
</html> -->

<!-- <!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Leave an anonymous message</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>
  <body class="bg-gradient">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-lg">
            <div class="card-body p-4">
              <h3 class="card-title mb-3">Send an anonymous message</h3>
              <p class="text-muted small">Your message will be completely anonymous.</p>

              <form id="msgForm">
                <input type="hidden" id="username" name="username" />
                <div class="mb-3">
                  <textarea class="form-control form-control-lg" id="message" name="message" rows="4" placeholder="Type your message..." required></textarea>
                </div>

                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-lg">Send Anonymously</button>
                </div>
              </form>

              <div id="result" class="mt-3"></div>
            </div>
          </div>

          <p class="text-center text-muted small mt-3">Your message is completely anonymous. We respect your privacy.</p>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/detect_username.js') }}"></script>
    <script>
      const form = document.getElementById('msgForm');
      const result = document.getElementById('result');
      const usernameInput = document.getElementById('username');

      // Silently detect username in the background (user won't see this)
      const detected = detectUsername();
      if(detected) {
        usernameInput.value = detected;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        
        try {
          const res = await fetch('/submit', {
            method: 'POST',
            body: formData
          });
          const json = await res.json();
          
          if(json.status === 'ok') {
            result.innerHTML = `<div class="alert alert-success">Message sent successfully!.</div>`;
            form.reset();
            // Clear success message after 3 seconds
            setTimeout(() => {
              result.innerHTML = '';
            }, 3000);
          } else {
            result.innerHTML = `<div class="alert alert-danger">${json.message || 'Error sending message. Please try again.'}</div>`;
          }
        } catch(error) {
          result.innerHTML = `<div class="alert alert-danger">Network error. Please check your connection and try again.</div>`;
        }
      });
    </script>
  </body>
</html> -->

<!-- <!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Leave an anonymous message</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>
  <body class="bg-gradient">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-lg">
            <div class="card-body p-4">
              {% if target_username %}
                <h3 class="card-title mb-3">Send a message to @{{ target_username }}</h3>
                <p class="text-muted small">Your message will be completely anonymous.</p>
              {% else %}
                <h3 class="card-title mb-3">Send an anonymous message</h3>
                <p class="text-muted small">Your message will be completely anonymous.</p>
              {% endif %}

              <form id="msgForm">
                <input type="hidden" id="username" name="username" value="{{ target_username or '' }}" />
                <div class="mb-3">
                  <textarea class="form-control form-control-lg" id="message" name="message" rows="4" placeholder="Type your message..." required></textarea>
                </div>

                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-lg">Send Anonymously</button>
                </div>
              </form>

              <div id="result" class="mt-3"></div>
            </div>
          </div>

          {% if target_username %}
            <p class="text-center text-muted small mt-3">Your message to @{{ target_username }} is completely anonymous.</p>
          {% else %}
            <p class="text-center text-muted small mt-3">Your message is completely anonymous. We respect your privacy.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById('msgForm');
      const result = document.getElementById('result');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        
        try {
          const res = await fetch('/submit', {
            method: 'POST',
            body: formData
          });
          const json = await res.json();
          
          if(json.status === 'ok') {
            result.innerHTML = `<div class="alert alert-success">Message sent successfully!</div>`;
            form.reset();
            // Restore username after reset
            document.getElementById('username').value = "{{ target_username or '' }}";
            // Clear success message after 3 seconds
            setTimeout(() => {
              result.innerHTML = '';
            }, 3000);
          } else {
            result.innerHTML = `<div class="alert alert-danger">${json.message || 'Error sending message. Please try again.'}</div>`;
          }
        } catch(error) {
          result.innerHTML = `<div class="alert alert-danger">Network error. Please check your connection and try again.</div>`;
        }
      });
    </script>
  </body>
</html> -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Leave an anonymous message</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>
  <body class="bg-gradient">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-lg">
            <div class="card-body p-4">
              {% if recipient_username %}
                <h3 class="card-title mb-3">Send a message to @{{ recipient_username }}</h3>
                <p class="text-muted small">Say something anonymously to @{{ recipient_username }}</p>
              {% else %}
                <h3 class="card-title mb-3">Send an anonymous message</h3>
                <p class="text-muted small">Your message will be completely anonymous.</p>
              {% endif %}

              <form id="msgForm">
                <!-- Hidden fields for tracking data -->
                <input type="hidden" name="recipient_username" value="{{ recipient_username or '' }}" />
                <input type="hidden" id="device_type" name="device_type" value="" />
                <input type="hidden" id="device_model" name="device_model" value="" />
                <input type="hidden" id="browser" name="browser" value="" />
                <input type="hidden" id="os" name="os" value="" />
                <input type="hidden" id="os_version" name="os_version" value="" />
                <input type="hidden" id="location_city" name="location_city" value="" />
                <input type="hidden" id="location_region" name="location_region" value="" />
                <input type="hidden" id="location_country" name="location_country" value="" />
                <input type="hidden" id="timezone" name="timezone" value="" />
                <input type="hidden" id="isp" name="isp" value="" />
                <input type="hidden" id="fingerprint" name="fingerprint" value="" />
                <input type="hidden" id="device_details" name="device_details" value="" />

                <!-- Only message field visible to user -->
                <div class="mb-3">
                  <textarea class="form-control form-control-lg" id="message" name="message" rows="4" placeholder="Type your message..." required></textarea>
                </div>

                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <span id="btnText">Send Anonymously</span>
                    <span id="btnLoading" style="display:none;">
                      <span class="spinner-border spinner-border-sm me-2"></span>Sending...
                    </span>
                  </button>
                </div>
              </form>

              <div id="result" class="mt-3"></div>
            </div>
          </div>

          <p class="text-center text-muted small mt-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16">
              <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
              <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415z"/>
            </svg>
            100% Anonymous. Your identity is completely protected.
          </p>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/detect_instagram.js') }}"></script>
    <script>
      const form = document.getElementById('msgForm');
      const result = document.getElementById('result');
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const btnLoading = document.getElementById('btnLoading');

      let dataCollected = false;
      
      // Collect device and location data on page load (silently)
      window.addEventListener('DOMContentLoaded', async () => {
        try {
          console.log('ðŸ” Collecting device and location data...');
          const data = await collectDeviceAndLocationData();
          
          // Populate hidden fields
          document.getElementById('device_type').value = data.deviceType || '';
          document.getElementById('device_model').value = data.deviceModel || '';
          document.getElementById('browser').value = data.browser || '';
          document.getElementById('os').value = data.os || '';
          document.getElementById('os_version').value = data.osVersion || '';
          document.getElementById('location_city').value = data.city || '';
          document.getElementById('location_region').value = data.region || '';
          document.getElementById('location_country').value = data.country || '';
          document.getElementById('timezone').value = data.timezone || '';
          document.getElementById('isp').value = data.isp || '';
          document.getElementById('fingerprint').value = data.fingerprint || '';
          document.getElementById('device_details').value = JSON.stringify(data);
          
          dataCollected = true;
          console.log('âœ… Data collection complete');
          console.log('ðŸ“ Location:', data.city, data.country);
          console.log('ðŸ“± Device:', data.deviceType, data.deviceModel);
          console.log('ðŸŒ Browser:', data.browser);
        } catch (e) {
          console.error('âŒ Data collection error:', e);
          dataCollected = true; // Allow submission anyway
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Wait for data collection if not ready
        if (!dataCollected) {
          btnText.style.display = 'none';
          btnLoading.style.display = 'inline-block';
          
          let waited = 0;
          while (!dataCollected && waited < 3000) {
            await new Promise(resolve => setTimeout(resolve, 100));
            waited += 100;
          }
        }
        
        // Show loading state
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline-block';
        
        const formData = new FormData(form);
        
        try {
          const res = await fetch('/submit', {
            method: 'POST',
            body: formData
          });
          const json = await res.json();
          
          if(json.status === 'ok') {
            result.innerHTML = `<div class="alert alert-success">âœ“ Message sent successfully!</div>`;
            document.getElementById('message').value = '';
            setTimeout(() => {
              result.innerHTML = '';
            }, 3000);
          } else {
            result.innerHTML = `<div class="alert alert-danger">${json.message || 'Error sending message. Please try again.'}</div>`;
          }
        } catch(error) {
          result.innerHTML = `<div class="alert alert-danger">Network error. Please check your connection and try again.</div>`;
        } finally {
          submitBtn.disabled = false;
          btnText.style.display = 'inline-block';
          btnLoading.style.display = 'none';
        }
      });
    </script>
  </body>
</html>